<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8">
    <title>Dussehra AR Filter</title>
    
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- Jeeliz FaceFilter Library -->
    <script src="https://cdn.jsdelivr.net/npm/jeeliz-facefilter@1.3.1/dist/jeeliz-facefilter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jeeliz-aframe@1.0.3/jeeliz-aframe.js"></script>

    <script>
        // A single, simple component to manage the arrow animation loop.
        AFRAME.registerComponent('arrow-shooter', {
            init: function () {
                // Get the 3D objects we need to work with
                this.faceAnchor = this.el.sceneEl.querySelector('#face-anchor');
                this.arrow = this.el.querySelector('#arrow-gif');
                this.ram = this.el.querySelector('#ram-model');

                // Bind the animation loop function to `this`
                this.shootLoop = this.shootLoop.bind(this);
                
                // Wait for the scene to be fully loaded before starting the animation
                this.el.sceneEl.addEventListener('loaded', () => {
                    // Add a small delay to ensure the face is tracked at least once
                    setTimeout(this.shootLoop, 2000); 
                });
            },

            shootLoop: function() {
                // Get the current world position of the user's face
                const facePosition = new THREE.Vector3();
                this.faceAnchor.object3D.getWorldPosition(facePosition);

                // Since the arrow is a child of the camera, we need to convert
                // the face's world position into the camera's local space.
                this.el.object3D.worldToLocal(facePosition);
                
                // Get Ram's position (which is already in the camera's local space)
                const ramPosition = this.ram.object3D.position;

                // Reset arrow to Ram's position and make it visible
                this.arrow.setAttribute('position', ramPosition);
                this.arrow.setAttribute('visible', true);

                // Set the animation to travel from Ram to the calculated face position
                this.arrow.setAttribute('animation', {
                    property: 'position',
                    to: `${facePosition.x} ${facePosition.y} ${facePosition.z}`,
                    dur: 1500, // Arrow flight time
                    easing: 'linear',
                    startEvents: 'fire'
                });

                // Start the animation
                this.arrow.emit('fire');

                // When the animation completes, hide the arrow and schedule the next shot
                this.arrow.addEventListener('animationcomplete', () => {
                    this.arrow.setAttribute('visible', false);
                    // Wait for 1 second before the next arrow
                    setTimeout(this.shootLoop, 1000); 
                }, { once: true });
            }
        });
    </script>
</head>
<body>
    
    <!-- 
      This Jeeliz component automatically starts the camera.
      The A-Frame scene is the container for all 3D objects.
    -->
    <a-scene jeeliz-facefilter="NNCPath: https://cdn.jsdelivr.net/npm/jeeliz-facefilter@1.3.1/dist/NNC.json;" embedded vr-mode-ui="enabled: false">
        
        <!-- The Raavan heads are anchored to the user's face -->
        <a-entity id="face-anchor" jeeliz-facefilter-occluder>
            <!-- Back Row -->
            <a-gltf-model src="./assets/raavan.gltf" position="-0.45 0.2 -0.35" scale="0.1 0.1 0.1" rotation="0 30 0"></a-gltf-model>
            <a-gltf-model src="./assets/raavan.gltf" position="-0.25 0.3 -0.3" scale="0.1 0.1 0.1" rotation="0 15 0"></a-gltf-model>
            <a-gltf-model src="./assets/raavan.gltf" position="0 0.35 -0.25" scale="0.1 0.1 0.1"></a-gltf-model>
            <a-gltf-model src="./assets/raavan.gltf" position="0.25 0.3 -0.3" scale="0.1 0.1 0.1" rotation="0 -15 0"></a-gltf-model>
            <a-gltf-model src="./assets/raavan.gltf" position="0.45 0.2 -0.35" scale="0.1 0.1 0.1" rotation="0 -30 0"></a-gltf-model>
            <!-- Front Row -->
            <a-gltf-model src="./assets/raavan.gltf" position="-0.4 0 -0.2" scale="0.1 0.1 0.1" rotation="0 25 0"></a-gltf-model>
            <a-gltf-model src="./assets/raavan.gltf" position="-0.2 0.05 -0.15" scale="0.1 0.1 0.1" rotation="0 15 0"></a-gltf-model>
            <a-gltf-model src="./assets/raavan.gltf" position="0 0.1 -0.1" scale="0.1 0.1 0.1"></a-gltf-model>
            <a-gltf-model src="./assets/raavan.gltf" position="0.2 0.05 -0.15" scale="0.1 0.1 0.1" rotation="0 -15 0"></a-gltf-model>
            <a-gltf-model src="./assets/raavan.gltf" position="0.4 0 -0.2" scale="0.1 0.1 0.1" rotation="0 -25 0"></a-gltf-model>
        </a-entity>
        
        <!-- 
          The camera contains Ram and the arrow.
          Being a child of the camera makes them "stick" to the screen.
          The `arrow-shooter` component manages the animation.
        -->
        <a-camera arrow-shooter>
            <a-gltf-model id="ram-model" src="./assets/ramtest.glb" position="0 -0.8 -2.5" scale="0.2 0.2 0.2" rotation="0 15 0"></a-gltf-model>
            
            <!-- 
              This is the arrow GIF. Make sure you have an `arrow.gif` file in your `assets` folder.
              The `shader: flat` property makes sure the GIF is always bright.
            -->
            <a-image id="arrow-gif" src="./assets/arrow.gif" width="0.2" height="0.2" shader="flat" visible="false"></a-image>
        </a-camera>

    </a-scene>
</body>
</html>

