<!DOCTYPE html>
<html>
  <head>
    <title>Dussehra AR Experience</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- A-Frame Library (Version updated for better compatibility) -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- MindAR Face Tracking Library for A-Frame -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-face-aframe.prod.js"></script>

    <style>
      /* Basic styling for a clean look */
      body {
        margin: 0;
        font-family: sans-serif;
      }
      /* Style for the loading overlay */
      #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #222;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        z-index: 10000;
      }
    </style>

    <script>
      // This component makes an arrow fly in a given direction
      AFRAME.registerComponent('arrow-fly', {
        schema: {
          direction: { type: 'vec3' },
          speed: { type: 'number', default: 8 }, // Speed of the arrow
          lifetime: { type: 'number', default: 3000 } // Arrow disappears after 3 seconds
        },

        init: function () {
          // Point the arrow in the direction it's traveling
          const targetPoint = this.el.object3D.position.clone().add(this.data.direction);
          this.el.object3D.lookAt(targetPoint);

          // Set a timer to remove the arrow entity after its lifetime
          setTimeout(() => {
            if (this.el && this.el.parentNode) {
              this.el.parentNode.removeChild(this.el);
            }
          }, this.data.lifetime);
        },

        tick: function (time, delta) {
          // Move the arrow forward every frame
          const dt = delta / 1000; // time in seconds
          const distance = this.data.speed * dt;
          const currentPos = this.el.object3D.position;

          currentPos.x += this.data.direction.x * distance;
          currentPos.y += this.data.direction.y * distance;
          currentPos.z += this.data.direction.z * distance;

          this.el.setAttribute('position', currentPos);
        }
      });

      // This component, attached to Ram, handles the shooting logic
      AFRAME.registerComponent('ram-shooter', {
        schema: {
          shootInterval: { type: 'number', default: 2500 } // Shoots an arrow every 2.5 seconds
        },
        
        init: function () {
          this.camera = document.querySelector('a-camera');
          this.lastShotTime = 0;
          this.ramWorldPos = new THREE.Vector3();
          this.cameraWorldPos = new THREE.Vector3();
          this.arReady = false; // Flag to check if MindAR is ready

          // Hide loader when scene is ready
          this.el.sceneEl.addEventListener('loaded', () => {
              const loader = document.getElementById('loader');
              if (loader) loader.style.display = 'none';
          });
          
          // Listen for the arReady event from the scene
          this.el.sceneEl.addEventListener('arReady', () => {
              this.arReady = true;
          });
        },

        tick: function (time, delta) {
          // Only run the logic if the AR system is ready and the camera exists
          if (!this.arReady || !this.camera) {
            return;
          }

          // Make Ram always look at the user (the camera)
          this.el.object3D.lookAt(this.camera.object3D.position);

          // Check if it's time to shoot again
          if (time - this.lastShotTime > this.data.shootInterval) {
            this.lastShotTime = time;
            this.shootArrow();
          }
        },
        
        shootArrow: function() {
          const scene = this.el.sceneEl;
          if (!scene) return;
          
          // Get current world positions of Ram and the camera
          this.el.object3D.getWorldPosition(this.ramWorldPos);
          this.camera.object3D.getWorldPosition(this.cameraWorldPos);
          
          // Calculate the direction vector from Ram to the camera
          const direction = this.cameraWorldPos.clone().sub(this.ramWorldPos).normalize();
          
          // Create a new arrow entity
          const arrow = document.createElement('a-entity');
          arrow.setAttribute('gltf-model', '#arrow-model');
          arrow.setAttribute('scale', '0.05 0.05 0.05'); // Adjust scale as needed
          arrow.setAttribute('position', this.ramWorldPos);
          
          // Attach the arrow-fly component to make it move
          arrow.setAttribute('arrow-fly', { direction: direction });
          
          // Add the arrow to the scene
          scene.appendChild(arrow);
        }
      });
    </script>
  </head>
  <body>
    <div id="loader">Loading AR Experience...</div>

    <!-- The main A-Frame scene with MindAR face tracking enabled -->
    <a-scene mindar-face embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      
      <!-- Asset management system to preload models -->
      <a-assets>
        <a-asset-item id="ram-model" src="ramtest.glb"></a-asset-item>
        <a-asset-item id="raavan-model" src="raavan.gltf"></a-asset-item>
        <a-asset-item id="arrow-model" src="overwatch_-_hanzos_arrow.glb"></a-asset-item>
      </a-assets>

      <!-- The camera is managed by MindAR -->
      <a-camera active="false" position="0 0 0"></a-camera>

      <!-- 
        This is the face tracking anchor.
        Anything inside this entity will move with your face.
      -->
      <a-entity mindar-face-target="anchorIndex: 0">
        <!-- Ten Raavan heads positioned in a circle around the user's face -->
        <a-gltf-model src="#raavan-model" position="0.00 0.50 0.00" scale="0.1 0.1 0.1" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model src="#raavan-model" position="0.35 0.35 0.00" scale="0.1 0.1 0.1" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model src="#raavan-model" position="0.50 0.00 0.00" scale="0.1 0.1 0.1" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model src="#raavan-model" position="0.35 -0.35 0.00" scale="0.1 0.1 0.1" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model src="#raavan-model" position="0.00 -0.50 0.00" scale="0.1 0.1 0.1" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model src="#raavan-model" position="-0.35 -0.35 0.00" scale="0.1 0.1 0.1" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model src="#raavan-model" position="-0.50 0.00 0.00" scale="0.1 0.1 0.1" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model src="#raavan-model" position="-0.35 0.35 0.00" scale="0.1 0.1 0.1" rotation="0 180 0"></a-gltf-model>
        <!-- Two extra heads for a total of 10 -->
        <a-gltf-model src="#raavan-model" position="0.25 0.60 0.00" scale="0.1 0.1 0.1" rotation="0 180 0"></a-gltf-model>
        <a-gltf-model src="#raavan-model" position="-0.25 0.60 0.00" scale="0.1 0.1 0.1" rotation="0 180 0"></a-gltf-model>
      </a-entity>
      
      <!-- 
        The Ram model is placed outside the face anchor.
        It will stay in one place relative to the world, shooting at you.
        The `ram-shooter` component starts the action.
      -->
      <a-entity 
        id="ram" 
        gltf-model="#ram-model" 
        position="0 0.5 -2.5" 
        scale="0.4 0.4 0.4"
        ram-shooter>
      </a-entity>

    </a-scene>
  </body>
</html>

